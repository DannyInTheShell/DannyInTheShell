<#
.SYNOPSIS
    Remediates CVE-2013-3900 (WinVerifyTrust Signature Validation) by enabling Cert Padding Check,
    or reverts the change, controlled by a boolean toggle. Creates the required registry keys on both 32-bit and 64-bit systems.

.DESCRIPTION
    When $makeSecure = $true:
      - Sets EnableCertPaddingCheck = 1 at:
          HKLM\Software\Microsoft\Cryptography\Wintrust\Config
          HKLM\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config (on 64-bit OS)
    When $makeSecure = $false:
      - Removes the EnableCertPaddingCheck value (if present) from the same locations
        to revert behavior (disabled if value is missing or equals 0).

    This mitigates the vulnerability related to signature validation (HIGH severity).
    Tenable Plugin ID: 166555

.AUTHOR
    Danny Cologero

.DATE CREATED
    10-15-2025

.VERSION
    1.3

.HOSTS
    Windows Server 2019 Datacenter (Build 1809)
    Windows 11
    PowerShell 5.1+

.USAGE
    1) Open PowerShell as Administrator.
    2) Navigate to the folder containing this script:
         cd C:\Path\To\Script
    3) Edit the toggle near the top of the script:
         $makeSecure = $true   # enable mitigation (remediate)
         $makeSecure = $false  # disable mitigation (revert)
    4) Run the script from its folder:
         .\remediation-cve-2013-3900.ps1
    5) Review output and the log in:
         C:\ProgramData\CVE-2013-3900_Remediation_Logs

.VERIFICATION
    - If $makeSecure = $true: value should be 1 (PASS)
    - If $makeSecure = $false: value should be missing or 0 (PASS)
    - Script prints PASS/FAIL for each relevant registry path.

.NOTES
    - Admin privileges required.
    - Idempotent: Safe to run multiple times in either mode.
#>

# -------------------------
# Toggle: Secure or Revert
# -------------------------
# $true  -> Remediate (enable mitigation)
# $false -> Revert (disable mitigation by removing the value)
$makeSecure = $true

# ----------------------------------------
# Logging Setup
# ----------------------------------------
$logFolder = "C:\ProgramData\CVE-2013-3900_Remediation_Logs"
if (-not (Test-Path -Path $logFolder)) {
    New-Item -ItemType Directory -Path $logFolder -Force | Out-Null
}
$logFile = "$logFolder\CVE-2013-3900_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"

function Log ($msg) {
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $entry = "[$timestamp] $msg"
    Add-Content -Path $logFile -Value $entry
}

# ----------------------------------------
# Console Helpers
# ----------------------------------------
function Info ($msg)  { Write-Host "[INFO]  $msg" -ForegroundColor Cyan; Log $msg }
function Warn ($msg)  { Write-Host "[WARN]  $msg" -ForegroundColor Yellow; Log $msg }
function ErrorExit ($msg) { Write-Host "[ERROR] $msg" -ForegroundColor Red; Log $msg; exit 1 }

# Ensure script runs as administrator
if (-not (New-Object Security.Principal.WindowsPrincipal `
  ([Security.Principal.WindowsIdentity]::GetCurrent())
).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    ErrorExit "Please run this script as Administrator."
}

# ----------------------------------------
# Define Registry Paths
# ----------------------------------------
$regPaths = @("HKLM:\Software\Microsoft\Cryptography\Wintrust\Config")
if ([Environment]::Is64BitOperatingSystem) {
    $regPaths += "HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config"
}

# ----------------------------------------
# Apply or Revert
# ----------------------------------------
foreach ($path in $regPaths) {
    try {
        if ($makeSecure) {
            # Ensure path exists, then set value to 1
            if (-not (Test-Path $path)) {
                Info "Registry path '$path' does not exist. Creating..."
                New-Item -Path $path -Force | Out-Null
            } else {
                Info "Registry path '$path' exists."
            }

            Info "Setting EnableCertPaddingCheck to 1 at '$path'."
            Set-ItemProperty -Path $path -Name "EnableCertPaddingCheck" -Value 1 -Type DWord -Force
            Info "Successfully set EnableCertPaddingCheck at '$path'."
        }
        else {
            # Revert: remove the value if present (fully disables)
            $existing = Get-ItemProperty -Path $path -Name "EnableCertPaddingCheck" -ErrorAction SilentlyContinue
            if ($null -ne $existing) {
                Info "Reverting: removing EnableCertPaddingCheck from '$path'."
                Remove-ItemProperty -Path $path -Name "EnableCertPaddingCheck" -ErrorAction SilentlyContinue
                Info "Removed EnableCertPaddingCheck from '$path'."
            } else {
                Info "Reverting: value not present at '$path' (already disabled)."
            }
        }
    }
    catch {
        ErrorExit "Failed to process '$path'. Error: $_"
    }
}

if ($makeSecure) {
    Info "CVE-2013-3900 remediation complete (mitigation ENABLED)."
    Log  "CVE-2013-3900 remediation complete (mitigation ENABLED)."
} else {
    Info "CVE-2013-3900 revert complete (mitigation DISABLED)."
    Log  "CVE-2013-3900 revert complete (mitigation DISABLED)."
}

# ----------------------------------------
# Automatic Verification
# ----------------------------------------
Info "`nStarting automatic verification..."

foreach ($path in $regPaths) {
    try {
        $value = $null
        try {
            $value = (Get-ItemProperty -Path $path -Name "EnableCertPaddingCheck" -ErrorAction Stop).EnableCertPaddingCheck
        } catch {
            $value = $null  # value missing
        }

        if ($makeSecure) {
            if ($value -eq 1) {
                Info "PASS: EnableCertPaddingCheck is set to 1 at '$path'."
            } else {
                Warn "FAIL: EnableCertPaddingCheck is not 1 at '$path' (current: $value)."
            }
        } else {
            if ($null -eq $value -or $value -eq 0) {
                Info "PASS: Mitigation reverted at '$path' (value missing or 0)."
            } else {
                Warn "FAIL: Mitigation not fully reverted at '$path' (current: $value)."
            }
        }
    }
    catch {
        Warn "FAIL: Unable to read EnableCertPaddingCheck at '$path'. Error: $_"
    }
}

Info "`nVerification complete. Review logs at $logFile for details."
Write-Host "`nLogs saved at $logFile"
